name: Release Build

# This workflow is triggered on pushes or pull request to the repository.
on:
  release:
    # Only use the types keyword to narrow down the activity types that will trigger your workflow.
    types: [prereleased, released]

jobs:
  centos-release:
    name: ${{ matrix.title }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        name:
          - conda-python3.6-release
          - conda-python3.7-release
          - conda-python3.6-cuda10.0-release
          - conda-python3.7-cuda10.0-release
        include:
          - name: conda-python3.6-release
            condapy: '3.6'
            centos: 7
            service: conda-build
            title: AMD64 CentOS 7 Conda Python 3.6 Release
          - name: conda-python3.7-release
            condapy: '3.7'
            centos: 7
            service: conda-build
            title: AMD64 CentOS 7 Conda Python 3.7 Release
          - name: conda-python3.6-cuda10.0-release
            condapy: '3.6'
            centos: 7
            cuda: '10.0'
            service: conda-cudagl-build
            title: AMD64 CentOS 7 Conda Python 3.6 CUDA 10.0 Release
          - name: conda-python3.7-cuda10.0-release
            condapy: '3.7'
            centos: 7
            cuda: '10.0'
            service: conda-cudagl-build
            title: AMD64 CentOS 7 Conda Python 3.7 CUDA 10.0 Release
    env:
      CENTOS: ${{ matrix.centos || 7 }}
      CONDA_PYTHON: ${{ matrix.condapy || '3.6' }}
      CUDA: ${{ matrix.cuda || '10.0' }}
    steps:
      # This step checks out a copy of your repository.
      - name: Checkout Arctern
        uses: actions/checkout@v1
      - name: Docker Pull
        shell: bash
        run: |
          docker-compose pull --ignore-pull-failures ${{ matrix.service }}
      - name: Docker Build
        shell: bash
        run: |
          docker-compose build ${{ matrix.service }}
      - name: Docker Run
        run: |
          docker-compose run -e GIT_BRANCH=${GITHUB_REF##*/} \
                             -e CONDA_USERNAME=arctern \
                             -e MY_UPLOAD_KEY=${{ secrets.RELEASE_ANACONDA_TOKEN }} \
                             ${{ matrix.service }}
